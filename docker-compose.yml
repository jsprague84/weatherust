services:
  weatherust:
    image: ghcr.io/jsprague84/weatherust:${WEATHERUST_TAG:-latest}
    env_file:
      - .env
    restart: "no"

  # Optional: Speedtest notifier service (image published separately)
  speedynotify:
    image: ghcr.io/jsprague84/speedynotify:${SPEEDYNOTIFY_TAG:-latest}
    env_file:
      - .env
    restart: "no"

  # Docker monitor: checks container health and CPU/MEM thresholds
  dockermon:
    image: ghcr.io/jsprague84/dockermon:${DOCKERMON_TAG:-latest}
    env_file:
      - .env
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: "no"

  # Update monitor: checks OS packages and Docker images across servers
  updatemon:
    image: ghcr.io/jsprague84/updatemon:${UPDATEMON_TAG:-latest}
    env_file:
      - .env
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${HOME}/.ssh:/root/.ssh:ro
    restart: "no"

  # Long-running runners so Ofelia can exec with full env inherited
  weatherust_runner:
    image: ghcr.io/jsprague84/weatherust:${WEATHERUST_TAG:-latest}
    container_name: weatherust_runner
    env_file:
      - .env
    entrypoint: ["/bin/sh", "-c", "sleep infinity"]
    restart: unless-stopped

  speedynotify_runner:
    image: ghcr.io/jsprague84/speedynotify:${SPEEDYNOTIFY_TAG:-latest}
    container_name: speedynotify_runner
    env_file:
      - .env
    entrypoint: ["/bin/sh", "-c", "sleep infinity"]
    restart: unless-stopped

  dockermon_runner:
    image: ghcr.io/jsprague84/dockermon:${DOCKERMON_TAG:-latest}
    container_name: dockermon_runner
    env_file:
      - .env
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    entrypoint: ["/bin/sh", "-c", "sleep infinity"]
    restart: unless-stopped

  updatemon_runner:
    image: ghcr.io/jsprague84/updatemon:${UPDATEMON_TAG:-latest}
    container_name: updatemon_runner
    env_file:
      - .env
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${HOME}/.ssh:/root/.ssh:ro
    entrypoint: ["/bin/sh", "-c", "sleep infinity"]
    restart: unless-stopped

  updatectl_runner:
    image: ghcr.io/jsprague84/updatectl:${UPDATECTL_TAG:-latest}
    container_name: updatectl_runner
    env_file:
      - .env
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:rw
      - ${HOME}/.ssh:/root/.ssh:ro
    entrypoint: ["/bin/sh", "-c", "sleep infinity"]
    restart: unless-stopped

  updatectl_webhook:
    image: ghcr.io/jsprague84/updatectl:${UPDATECTL_TAG:-latest}
    container_name: updatectl_webhook
    env_file:
      - .env
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:rw
      - ${HOME}/.ssh:/root/.ssh:ro
    entrypoint: ["/app/updatectl"]
    command: ["serve", "--port", "8080"]
    ports:
      - "127.0.0.1:8080:8080"  # Only expose on localhost for security
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  ofelia:
    image: mcuadros/ofelia:latest
    container_name: ofelia
    restart: unless-stopped
    environment:
      - TZ=America/Chicago
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${ENV_FILE_HOST_PATH}:/ofelia/.env:ro
    command: daemon --docker
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.weatherust.schedule=0 30 5 * * *"
      - "ofelia.job-exec.weatherust.container=weatherust_runner"
      - "ofelia.job-exec.weatherust.command=/app/weatherust --zip 52726 --units imperial --quiet"

      # Speedtest daily at 02:10
      - "ofelia.job-exec.speedynotify.schedule=0 10 2 * * *"
      - "ofelia.job-exec.speedynotify.container=speedynotify_runner"
      - "ofelia.job-exec.speedynotify.command=/app/speedynotify --quiet --min-down ${SPEEDTEST_MIN_DOWN} --min-up ${SPEEDTEST_MIN_UP}"

      # Docker monitor every 5 minutes (exec inside runner to inherit env_file)
      - "ofelia.job-exec.dockermon.schedule=0 */5 * * * *"
      - "ofelia.job-exec.dockermon.container=dockermon_runner"
      - "ofelia.job-exec.dockermon.command=/app/dockermon --quiet"

      # Update monitor daily at 03:00 (checks OS packages and Docker images)
      # NOTE: Add localhost to UPDATE_SERVERS (e.g., "docker-vm:local,...") to include it automatically
      # Or use --local flag as shown below
      - "ofelia.job-exec.updatemon.schedule=0 0 3 * * *"
      - "ofelia.job-exec.updatemon.container=updatemon_runner"
      - "ofelia.job-exec.updatemon.command=/app/updatemon --docker --quiet"

      # Update controller - OPTIONAL automated updates (DISABLED by default)
      # CAUTION: Auto-updates can break services. Test thoroughly before enabling.
      # Uncomment the desired schedule(s) below to enable automated updates.
      #
      # Weekly OS updates only (Sundays at 04:00)
      # - "ofelia.job-exec.updatectl-os.schedule=0 0 4 * * 0"
      # - "ofelia.job-exec.updatectl-os.container=updatectl_runner"
      # - "ofelia.job-exec.updatectl-os.command=/app/updatectl os --yes --local --quiet"
      #
      # Weekly Docker updates (Sundays at 04:30)
      # - "ofelia.job-exec.updatectl-docker.schedule=0 30 4 * * 0"
      # - "ofelia.job-exec.updatectl-docker.container=updatectl_runner"
      # - "ofelia.job-exec.updatectl-docker.command=/app/updatectl docker --all --yes --local --quiet"
      #
      # Monthly full updates (1st of month at 05:00)
      # - "ofelia.job-exec.updatectl-all.schedule=0 0 5 1 * *"
      # - "ofelia.job-exec.updatectl-all.container=updatectl_runner"
      # - "ofelia.job-exec.updatectl-all.command=/app/updatectl all --yes --local --quiet"
