services:
  weatherust:
    image: ghcr.io/jsprague84/weatherust:${WEATHERUST_TAG:-latest}
    env_file:
      - .env
    restart: "no"

  # Optional: Speedtest notifier service (image published separately)
  speedynotify:
    image: ghcr.io/jsprague84/speedynotify:${SPEEDYNOTIFY_TAG:-latest}
    env_file:
      - .env
    restart: "no"

  # Docker monitor: checks container health and CPU/MEM thresholds
  dockermon:
    image: ghcr.io/jsprague84/dockermon:${DOCKERMON_TAG:-latest}
    env_file:
      - .env
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: "no"

  ofelia:
    image: mcuadros/ofelia:latest
    container_name: ofelia
    restart: unless-stopped
    environment:
      - TZ=America/Chicago
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${ENV_FILE_HOST_PATH}:/ofelia/.env:ro
    command: daemon --docker
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-run.weatherust.schedule=0 30 5 * * *"
      - "ofelia.job-run.weatherust.image=ghcr.io/jsprague84/weatherust:${WEATHERUST_TAG:-latest}"
      - "ofelia.job-run.weatherust.command=--zip 52726 --units imperial --quiet"
      - "ofelia.job-run.weatherust.env-file=/ofelia/.env"
      - "ofelia.job-run.weatherust.env=OWM_API_KEY=${OWM_API_KEY}|GOTIFY_KEY=${GOTIFY_KEY}|GOTIFY_URL=${GOTIFY_URL}|DEFAULT_ZIP=${DEFAULT_ZIP}|DEFAULT_LOCATION=${DEFAULT_LOCATION}|DEFAULT_UNITS=${DEFAULT_UNITS}"

      # Speedtest daily at 02:10 (disabled until image exists)
      - "ofelia.job-run.speedynotify.schedule=0 10 2 * * *"
      - "ofelia.job-run.speedynotify.image=ghcr.io/jsprague84/speedynotify:${SPEEDYNOTIFY_TAG:-latest}"
      - "ofelia.job-run.speedynotify.command=--quiet --min-down ${SPEEDTEST_MIN_DOWN} --min-up ${SPEEDTEST_MIN_UP}"
      - "ofelia.job-run.speedynotify.env-file=/ofelia/.env"
      - "ofelia.job-run.speedynotify.env=GOTIFY_KEY=${GOTIFY_KEY}|GOTIFY_URL=${GOTIFY_URL}|SPEEDY_GOTIFY_KEY=${SPEEDY_GOTIFY_KEY}|SPEEDTEST_MIN_DOWN=${SPEEDTEST_MIN_DOWN}|SPEEDTEST_MIN_UP=${SPEEDTEST_MIN_UP}|SPEEDTEST_SERVER_ID=${SPEEDTEST_SERVER_ID}"

      # Docker monitor every 5 minutes (job-run with env + docker socket)
      - "ofelia.job-run.dockermon.schedule=0 */5 * * * *"
      - "ofelia.job-run.dockermon.image=ghcr.io/jsprague84/dockermon:${DOCKERMON_TAG:-latest}"
      - "ofelia.job-run.dockermon.command=--quiet"
      - "ofelia.job-run.dockermon.env-file=/ofelia/.env"
      - "ofelia.job-run.dockermon.env=GOTIFY_KEY=${GOTIFY_KEY}|DOCKERMON_GOTIFY_KEY=${DOCKERMON_GOTIFY_KEY}|GOTIFY_URL=${GOTIFY_URL}|GOTIFY_DEBUG=${GOTIFY_DEBUG}|HEALTH_NOTIFY_ALWAYS=${HEALTH_NOTIFY_ALWAYS}|CPU_WARN_PCT=${CPU_WARN_PCT}|MEM_WARN_PCT=${MEM_WARN_PCT}"
      - "ofelia.job-run.dockermon.volume=/var/run/docker.sock:/var/run/docker.sock:ro"
